<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.springboot.member.UserMapper">


    <!--  회원가입  -->
    <insert id="insertUser" 
    	parameterType="com.project.springboot.member.UserDTO">
        INSERT INTO USER_INFO
        (u_num, u_id, u_pw, u_name, u_nick, u_phone, u_email, u_zip, u_addr1, u_addr2, u_type)
        VALUES(seq_user_num.nextval,#{u_id},#{u_pw},#{u_name},#{u_nick},#{u_phone},
        		#{u_email},#{u_zip},#{u_addr1},#{u_addr2},'일반')
    </insert>
    
    
    <!-- 회원정보 수정 -->
	<update id="updateUser" parameterType="com.project.springboot.member.UserDTO">
	   <choose>
			<when test = "#{u_pw} != null">
				UPDATE USER_INFO SET
			    u_pw = #{u_pw},
			    u_nick = #{u_nick},
			    u_phone = #{u_phone},
			    u_email = #{u_email},
			    u_zip = #{u_zip},
			    u_addr1 = #{u_addr1},
			    u_addr2 = #{u_addr2}
			    WHERE u_id = #{u_id}
			</when>
			<otherwise>
				UPDATE USER_INFO SET
				    u_nick = #{u_nick},
				    u_phone = #{u_phone},
				    u_email = #{u_email},
				    U_Zip = #{u_zip},
				    u_addr1 = #{u_addr1},
				    u_addr2 = #{u_addr2}
				    WHERE u_id = #{u_id}
			</otherwise>
		</choose>
	</update>

    <!-- 회원탈퇴 -->
	<delete id="deleteUser" parameterType="String">
	    DELETE FROM USER_INFO WHERE u_id = #{u_id}
	</delete>
	
	<select id="selectOne" resultType="com.project.springboot.member.UserDTO">
		SELECT * FROM USER_INFO WHERE u_id = #{param1}
	</select>
	<!-- 전체조회  -->
	<select id="selectAll" resultType="com.project.springboot.member.UserDTO">
       SELECT * FROM USER_INFO
   </select>
   
   <!-- 블랙리스트 조회 -->
   <select id="selectBlacklist" resultType="com.project.springboot.member.UserDTO">
    	SELECT * FROM USER_INFO WHERE u_authority = 'ROLE_BLACKLIST'
	</select>
   <!--  조회 -->
   <select id="selectUserlist" resultType="com.project.springboot.member.UserDTO">
    	SELECT * FROM USER_INFO WHERE u_authority = 'ROLE_USER'
	</select>
	
	<!-- 권한 업데이트 -->
	<update id="updateAuthority">
	    UPDATE USER_INFO SET u_authority = #{param2} WHERE u_id = #{param1}
	</update>
	
	<!--  상품 재고 관련 -->
	<insert id="addStock" parameterType="com.project.springboot.productdto.PCountDTO">
	    INSERT INTO p_count (P_Barcode, P_Num, P_Sold)
	    VALUES (
	      #{barcode},
	      (SELECT P_Num FROM product_list WHERE P_Barcode = #{barcode}),
	      'N'
	    )
	    ON DUPLICATE KEY UPDATE
	    P_Num = (SELECT P_Num FROM product_list WHERE P_Barcode = #{barcode}),
	    P_Sold = 'N';
	    
	    UPDATE p_count
	    SET P_Num = P_Num + #{quantity}
	    WHERE P_Barcode = #{barcode};
  </insert>
	
	<insert id="insertSnsUser" parameterType="com.project.springboot.oauth2.SnsDTO">
        INSERT INTO USER_INFO (u_id, u_pw, u_name, u_nick, u_phone, u_zip, u_addr1, u_addr2, u_type )
         VALUES (#{u_id}, #{u_pw}, #{u_name}, #{u_nick}, #{u_phone}, #{u_zip}, #{u_addr1}, #{u_addr2},'SNS')
	</insert>
	

   
</mapper> 