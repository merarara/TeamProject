<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.project.springboot.pservice.PListDao">
	<!-- 페이지설정 -->
	<select id="articlePageDao" resultType="_int">
		select count(*) as total from product_list
		 <if test="sField != 'p_price' and sField != null and sWord != null and sField != '' and sWord != '' and type == 'select'">
		 	where ${sField} = #{sWord}
		 </if>
		 <if test="sField != 'p_price' and sField != null and sField != '' and sWord != '' and sWord != '' and type == 'search'">
          	where upper(${sField}) like '%${sWord.toUpperCase()}%'
         </if>
         <if test="sField == 'p_price' and sWord == '500001'">
         	where ${sField} <![CDATA[<]]> 500000
        	<if test="selected != '' and selected != null">
          	  and p_company = #{selected}
            </if>
         </if>
         <if test="sField == 'p_price' and sWord == '500000' or sWord == '1000000' or sWord == '1500000'">
         	where ${sField} between ${sWord} and ${sWord} + 500000
       		<if test="selected != '' and selected != null">
         	  and p_company = #{selected}
         	</if>
         </if>
         <if test="sField == 'p_price' and sWord == '2000000' or sWord == '3000000' or sWord == '4000000'">
         	where ${sField} between ${sWord} and ${sWord} + 1000000
       		<if test="selected != '' and selected != null">
         	  and p_company = #{selected}
         	</if>
         </if>
         <if test="sField == 'p_price' and sWord == '5000000'">
         	where ${sField} <![CDATA[>=]]> 5000000
        	<if test="selected != '' and selected != null">
          	  and p_company = #{selected}
            </if>
         </if>
	</select>
	
	<!-- 리스트뷰 -->
	<select id="listDao" resultType="com.project.springboot.productdto.ProductlistDTO">
		select *
		  from (
		  		select rownum num, A.*
		  		  from (
		  		        select *
		  		          from product_list
		  		          <if test="sField == 'p_price' and sWord == '500001'">
		  		          	where ${sField} <![CDATA[<]]> 500000
		  		          	<if test="selected != '' and selected != null">
		  		          	  and p_company = #{selected}
		  		          	</if>
		  		          	order by ${sField}
		  		          </if>
		  		          <if test="sField == 'p_price' and sWord == '500000' or sWord == '1000000' or sWord == '1500000'">
		  		          	where ${sField} between ${sWord} and ${sWord} + 500000
	  		          		<if test="selected != '' and selected != null">
				          	  and p_company = #{selected}
				          	</if>
					        order by ${sField}
		  		          </if>
		  		          <if test="sField == 'p_price' and sWord == '2000000' or sWord == '3000000' or sWord == '4000000'">
		  		          	where ${sField} between ${sWord} and ${sWord} + 1000000
	  		          		<if test="selected != '' and selected != null">
				          	  and p_company = #{selected}
				          	</if>
					        order by ${sField}
		  		          </if>
		  		          <if test="sField == 'p_price' and sWord == '5000000'">
		  		          	where ${sField} <![CDATA[>=]]> 5000000
	  		          		<if test="selected != '' and selected != null">
				          	  and p_company = #{selected}
				          	</if>
					        order by ${sField}
		  		          </if>
		  		          <if test="sField != 'p_price' and sField != null and sWord != null and sField != '' and sWord != '' and type == 'select'">
		  		           	where ${sField} = #{sWord}
		  		          </if>
		  		          <if test="sField != 'p_price' and sField != null and sField != '' and sField != '' and sWord != '' and type == 'search'">
		  		          	where upper(${sField}) like '%${sWord.toUpperCase()}%'
		  		          </if>
		  		         ) A
		  		  where rownum <![CDATA[<=]]> #{nEnd} ) B
		  where B.num <![CDATA[>=]]> #{nStart}
	</select>
	
	<!-- 상품 재고 업데이트 -->
	
	<!-- 상품 상세 페이지 -->
	<select id="viewpinfoDao" 
		parameterType="int"
		resultType="com.project.springboot.productdto.ProductinfoDTO">
		select f.*, l.p_price, l.p_rdate, l.p_rating, l.p_listimg, l.p_count
		  from product_info f, product_list l
		 where f.p_num = l.p_num
		   and f.p_num = #{param1}
	</select>
	
	<!-- 구매 확인 -->
	<select id="buyCheckDao1"
		resultType="String">
		select u_id
		  from order_info 
		 where p_num = #{param1}
	</select>
	
	<!-- 구매 확인 -->
	<select id="buyCheckDao2"
		resultType="String">
		select u_id
		  from b_orderinfo 
		 where p_num = #{param1}
	</select>
	
	<!-- 상품 검색 자동완성 -->
	<select id="wordSearchShowDao" parameterType="HashMap" resultType="String">
		<choose>
    		<when test="searchfield eq 'p_name'">
    			select p_name
    			from(
    			select rownum as rnum, p_name
				from(
					select distinct p_name
					from product_list
					where p_name like '%${searchword.toUpperCase()}%'
				)
				where rownum <![CDATA[<]]> 6
				)
    		</when>
    		<otherwise>
    			select ${searchfield} 
				from(
					select ROWNUM as rnum, ${searchfield}
					from (
					select distinct ${searchfield}
					from product_list
					where ${searchfield} like '%${searchword.toUpperCase()}%'
					)
				)
				where rownum <![CDATA[<]]> 6
    		</otherwise>
    	</choose>   
	</select>
	
	<!-- 단품 결제 정보 입력 -->
	<insert id="insertOrderDao"
		parameterType="com.project.springboot.productdto.OrderinfoDTO">
		insert into order_info (m_num, u_id, m_addr, p_num, m_price, m_qty, p_name, p_price) 
		values (seq_o_num.nextval, #{u_id}, #{m_addr}, ${p_num}, ${m_price}, ${m_qty}, #{p_name}, #{p_price})
	</insert>
	
	<!-- 구매 후 SCount 증가 -->
	<update id="update_SCountDao">
		update product_list
		   set p_scount = p_scount + 1
		 where p_num = #{param1}
	</update>
</mapper>